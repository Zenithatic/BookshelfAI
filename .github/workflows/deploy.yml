name: Build Application

on:
    push:
        branches:
            - 'main'            # Ensure this only triggers on the 'main' branch

    pull_request:
        branches:
            - 'main'            # Ensure the workflow triggers on pull requests targeting the 'main' branch

jobs: 
    build:
        runs-on: ubuntu-latest

        services:
         selenium:
          image: selenium/standalone-chrome
          ports:
            - 4444:4444

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Login to DockerHub
              run: echo "${{ secrets.DOCKER_PASS }}" | docker login -u "${{ secrets.DOCKER_USER }}" --password-stdin

            - name: Copy environment variables from repo secrets to .env for backend
              run: | 
                echo "DB_URL=${{ secrets.DB_URL }}" >> ./backend/.env
                echo "GMAIL_USER=${{ secrets.GMAIL_USER }}" >> ./backend/.env
                echo "GMAIL_PASS=${{ secrets.GMAIL_PASS }}" >> ./backend/.env
                echo "JWT_KEY=${{ secrets.JWT_KEY }}" >> ./backend/.env
            
            - name: Build the frontend docker image
              run: docker build -t ${{ secrets.DOCKER_USER }}/bookshelfai-frontend:latest ./frontend
            
            - name: Build the backend docker image
              run: docker build -t ${{ secrets.DOCKER_USER }}/bookshelfai-backend:latest ./backend

            - name: Run the frontend docker image for tests
              run: docker run -d --name baf -p 80:80 ${{ secrets.DOCKER_USER }}/bookshelfai-frontend:latest

            - name: Run the backend docker image for tests
              run: docker run -d --name bab -p 3000:3000 ${{ secrets.DOCKER_USER }}/bookshelfai-backend:latest

            - name: Setup python
              uses: actions/setup-python@v5
              with:
                  python-version: '3.12'
            
            - name: Install dependencies
              run: pip install pytest selenium
            
            - name: Run tests
              run: python -m "pytest" ./frontend/python/tests

            - name: Stop containers 
              run: docker stop $(docker ps -a -q)

            - name: Remove old containers
              run: docker rm $(docker ps -a -q)

            - name: Replace backend url in env.js for frontend
              run: sed -i 's#http://localhost:3000#https://bookshelfai-backend.onrender.com#g' ./frontend/js/env.js

            - name: Rebuild the frontend docker image
              run: docker build -t ${{ secrets.DOCKER_USER }}/bookshelfai-frontend:latest ./frontend
            
            - name: Rebuild the backend docker image
              run: docker build -t ${{ secrets.DOCKER_USER }}/bookshelfai-backend:latest ./backend

            - name: Push the frontend docker image to docker hub
              run: docker push ${{ secrets.DOCKER_USER }}/bookshelfai-frontend:latest 

            - name: Push the backend docker image to docker hub
              run: docker push ${{ secrets.DOCKER_USER }}/bookshelfai-backend:latest 

            - name: Send request to Render to redeploy backend
              run: curl ${{ secrets.RENDER_DEPLOY_HOOK_URL_BACKEND }}

            - name: Send request to Render to redeploy frontend
              run: curl ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
